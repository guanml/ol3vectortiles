<!DOCTYPE html>
<html>
  <head>
    <title>Declutter</title>
    <link rel="stylesheet" href="https://openlayers.org/en/master/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="ol.js"></script>

    <script src='styles/style-roads-0-2500.js'></script>
    <script src='styles/style-roads-2500-15000.js'></script>
    <script src='styles/style-roads-15000-30000.js'></script>
    <script src='styles/style-roads-30000-100000.js'></script>
    <script src='styles/style-roads-100000-250000.js'></script>
    <script src='styles/style-roads-250000-1000000.js'></script>
    <script src='styles/style-roads-1000000-2500000.js'></script>
    <script src='styles/style-roads-2500000-5000000.js'></script>
    <script src='styles/style-roads-5000000-40000000.js'></script>
    <script src='styles/style-landusage.js'></script>
  </head>
  <body>
    <div id="map" class="map"></div>
    <script>
      var getCurrentScale = function () {
          var view = map.getView(),
              resolution = view.getResolution(),
              units = map.getView().getProjection().getUnits(),
              dpi = 25.4 / 0.28,
              mpu = ol.proj.METERS_PER_UNIT[units],
              scale = resolution * mpu * 39.37 * dpi;
          return scale;
      };

      var labelTextStroke = new ol.style.Stroke({
          color: '#fff',
          width: 3
      });
      var labelTextFill = new ol.style.Fill({
          color: '#000'
      });
      var labelStyle = new ol.style.Style({
          text: new ol.style.Text({
              font: '13px Calibri,sans-serif',
              fill: labelTextFill,
              stroke: labelTextStroke,
              placement: 'line'
          })
      });

      var buildRoadStyle = function(feature, resolution, styleObject) {

          var props = feature.getProperties(),
              type = props.type || null,
              text = props.name || props.ref || null,
              isHighWay = props.type === 'motorway' && props.class === 'highway' && props.ref.indexOf("A") > -1;

          var styleArray = [],
              below = new ol.style.Style({
                  stroke: new ol.style.Stroke({
                      color: styleObject.style[type].colors[0] || 'black',
                      width: styleObject.style[type].widths[0] || 2,
                      lineCap: 'butt',
                      opacity: styleObject.style[type].opacity || 1,
                      lineDash: styleObject.style[type].dasharray ? styleObject.style[type].dasharray.split(' ') : []
                  }),
                  zIndex: feature.get('z_order') || 0
              });

          styleArray.push(below);

          // check if we need a "outline" for this road
          if (styleObject.style[type].widths.length > 1) {
              var above = new ol.style.Style({
                  stroke: new ol.style.Stroke({
                      color: styleObject.style[type].colors[1] || 'white',
                      width: styleObject.style[type].widths[1] || 1,
                      lineCap: styleObject.style[type].caps[1] || 'round',
                      opacity: styleObject.style[type].opacity || 1
                  }),
                  zIndex: feature.get('z_order')
              });
              styleArray.push(above);
          }

          labelStyle.getText().setText(feature.get('name'));
          labelStyle.setZIndex(feature.get('z_order'));
          styleArray.push(labelStyle);

          return styleArray;
      };

      var viewExtent = [1817379, 6139595, 1827851, 6143616];
      var map = new ol.Map({
        layers: [
          new ol.layer.VectorTile({
              name: 'roads',
              renderMode: 'image',
              declutter: true,
              maxResolution: 35,
              source: new ol.source.VectorTile({
                format: new ol.format.TopoJSON(),
                tileGrid: ol.tilegrid.createXYZ({
                  tileSize: [512,512]
                }),
                url: 'http://ows.terrestris.de/vectortiles/osm-roads/{z}/{x}/{y}.topojson'
              }),
              style: function(feature, resolution) {
                  var props = feature.getProperties(),
                      type = props.type || null,
                      style,
                      scale = getCurrentScale();

                  if (scale > 5000000) {
                      style = style_roads_5000000_40000000;
                  } else if (scale > 2500000) {
                      style = style_roads_2500000_5000000;
                  } else if (scale > 1000000) {
                      style = style_roads_1000000_2500000;
                  } else if (scale > 250000) {
                      style = style_roads_250000_1000000;
                  } else if (scale > 100000) {
                      style = style_roads_100000_250000;
                  } else if (scale > 30000) {
                      style = style_roads_30000_100000;
                  } else if (scale > 15000) {
                      style = style_roads_15000_30000;
                  } else if (scale > 2500) {
                      style = style_roads_2500_15000;
                  } else {
                      style = style_roads_0_2500;
                  }

                  // try to detect the style
                  if (style.style[type]) {
                      return buildRoadStyle(feature, resolution, style);
                  } else {
                    return null;
                  }
              }
          })
        ],
        target: 'map',
        view: new ol.View({
            center: [789943.208725382, 6574238.796471646],
            zoom: 14
        })
      });
    </script>
  </body>
</html>
